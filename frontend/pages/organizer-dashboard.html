<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../assets/styles/organizer-dashboard.css">
  <title>Event Organizer Dashboard</title>
</head>
<body>
  <header class="header">
    <nav class="navbar">
      <div class="logo"><a href="#">EventHub</a></div>
      <ul class="nav-links">
        <li><a href="#">Home</a></li>
        <li><a href="#">Dashboard</a></li>
        <li><a href="org-create-event.html">Create Event</a></li>
        <li><a href="#">Profile</a></li>
        <li><a href="#">Logout</a></li>
      </ul>
    </nav>
  </header>

  <main class="main-container">
    <section class="user-profile">
      <div class="profile-info">
        <img src="" alt="User Profile Image" class="profile-image" id="profileImage">
        <div class="user-details">
          <h1 class="username">Welcome, <span id="username">[Username]</span></h1>
          <p class="user-bio">Bio: <span id="userBio">[User Bio]</span></p>
          <p class="user-email">Email: <span id="userEmail">[User Email]</span></p>
        </div>
      </div>
      <button class="edit-profile-button" id="editProfileButton">Edit Profile</button>
    </section>

    <section class="user-events">
      <h1>Your Created Events</h1>
      <div class="event-list" id="eventList">
      </div>
    </section>

    <section class="event-attendees">
      <h1>Event Attendees</h1>
      <div class="attendee-list" id="attendeeList">
      </div>
    </section>
  </main>

  <footer class="footer">
        &copy; 2023 Your Event Website
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      async function fetchOrganizerProfile(token, userId) {
        try {
          const response = await fetch(`http://localhost:5000/api/v1/auth/user/${userId}`, {
            method: "GET",
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${token}`,
            },
          });
          const data = await response.json();
          return data;
          
          const profileImage = document.getElementById("profileImage");
          const username = document.getElementById("username");
          const userBio = document.getElementById("userBio");
          const userEmail = document.getElementById("userEmail");

          profileImage.src = data.profile_image;
          username.textContent = `Welcome, ${data.username}`;
          userBio.textContent = `Bio: ${data.bio}`;
          userEmail.textContent = `Email: ${data.email}`;

        } catch (error) {
          console.error('Error fetching user events:', error);
          return [];
        }
      }

      async function fetchUserEvents(token) {
        try {
          const response = await fetch(`http://localhost:5000/api/v1/events/user/${userId}`, {
            method: "GET",
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${token}`,
            },
          });
          const data = await response.json();
          return data;
        } catch (error) {
          console.error('Error fetching user events:', error);
          return [];
        }
      }

      function renderUserEventCards(events) {
        const eventList = document.getElementById("eventList");

        eventList.innerHTML = "";

        if (events.length === 0) {
          const noEventsMessage = document.createElement("p");
          noEventsMessage.textContent = "You have not created any events yet.";
          eventList.appendChild(noEventsMessage);
          return;
        }

        events.forEach(event => {
          const eventCard = document.createElement("div");
          eventCard.classList.add("event-card");

          const eventDate = new Date(event.event_date);
          const formattedDate = eventDate.toDateString();

          eventCard.innerHTML = `
          <h2>${event.event_name}</h2>
          <p>Date: ${formattedDate}</p>
          <p>Time: ${event.event_time}</p>
          <p>Location: ${event.location}</p>
          <p>Description:</p>
          <p>${event.description}</p>

          <button class="view-attendees-button" data-event-id="${event.event_id}">View Attendees</button>
          <button class="view-event-button" data-event-id="${event.event_id}">View Event</button>
            `;

          const viewAttendeesButton = eventCard.querySelector(".view-attendees-button");
          viewAttendeesButton.addEventListener("click", () => {
            const eventId = viewAttendeesButton.getAttribute("data-event-id");
            navigateToEventAttendeesPage(eventId);
          });

          const viewEventButton = eventCard.querySelector(".view-event-button");
          viewEventButton.addEventListener("click", () => {
            const eventId = viewEventButton.getAttribute("data-event-id");
            navigateToEventDetailsPage(eventId);
          });

          eventList.appendChild(eventCard);
        });
      }

      function navigateToEventAttendeesPage(eventId) {
        const eventAttendeesPageUrl = `event-attendees.html?eventId=${eventId}`;
        window.location.href = eventAttendeesPageUrl;
      }

      function navigateToEventDetailsPage(eventId) {
        const eventDetailsPageUrl = `event-details.html?eventId=${eventId}`;
        window.location.href = eventDetailsPageUrl;
      }

      async function viewEventAttendees(eventId) {
        const token = sessionStorage.getItem('accessToken');

        if (token) {
          const attendees = await fetchEventAttendees(token, eventId);
          renderEventAttendees(attendees);
        }
      }

      async function fetchEventAttendees(token, eventId) {
        try {
          const response = await fetch(`http://localhost:5000/api/v1/events/${eventId}/attendees`, {
            method: "GET",
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${token}`,
            },
          });
          const data = await response.json();
          return data;
        } catch (error) {
          console.error('Error fetching event attendees:', error);
          return [];
        }
      }

      async function renderEventAttendees(attendees) {
        const attendeeList = document.getElementById("attendeeList");

        attendeeList.innerHTML = "";

        if (attendees.length === 0) {
          const noAttendeesMessage = document.createElement("p");
          noAttendeesMessage.textContent = "No attendees for this event yet.";
          attendeeList.appendChild(noAttendeesMessage);
          return;
        }

        attendees.forEach(attendee => {
          const attendeeCard = document.createElement("div");
          attendeeCard.classList.add("attendee-card");

          attendeeCard.innerHTML = `
          <h3>${attendee.name}</h3>
          <p>Email: ${attendee.email}</p>
            `;

          attendeeList.appendChild(attendeeCard);
        });
      }

      const userId = sessionStorage.getItem('userId');
      const token = sessionStorage.getItem('accessToken');
      
      if (token) {
        const userEvents = await fetchUserEvents(token, userId);
        renderUserEventCards(userEvents.events);
      }

      const editProfileButton = document.getElementById("editProfileButton");

      editProfileButton.addEventListener("click", () => {
        window.location.href = "update-profile.html";
      });
    });
  </script>
</body>
</html>
