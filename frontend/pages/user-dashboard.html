<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../assets/styles/user-dashboard.css">
  <title>User Dashboard</title>
</head>
<body>
  <header>
    <nav>
      <div class="logo"><a href="#">EventHub</a></div>
      <ul class="nav-links">
        <li><a href="#">Home</a></li>
        <li><a href="#">Dashboard</a></li>
        <li><a href="#">Discover Events</a></li>
        <li><a href="#">Profile</a></li>
        <li><a href="#">Logout</a></li>
      </ul>
    </nav>
  </header>

  <main class="main-container">
    <section class="user-profile">
      <h1>User Profile</h1>
      <div class="user-details">
        <div class="profile-image">
          <img src="" alt="User Profile Image" id="profileImage">
        </div>
        <div class="profile-info">
          <p><strong>Name:</strong> <span id="profileName"></span></p>
          <p><strong>Email:</strong> <span id="profileEmail"></span></p>
          <p><strong>Bio:</strong> <span id="profileBio"></span></p>
          <button class="edit-profile-button">Edit Profile</button>
        </div>
      </div>
    </section>

    <section class="discover-events">
      <h1>Discover Events</h1>
      <div class="event-filters">
        <label for="event-category">Category:</label>
        <select id="event-category">
          <option value="all">All</option>
          <option value="music">Music</option>
          <option value="sports">Sports</option>
          <option value="business">Business</option>
          <option value="food">Food</option>
        </select>
        <label for="event-location">Location:</label>
        <input type="text" id="event-location" placeholder="Enter location">
        <button id="apply-filters">Apply Filters</button>
      </div>
      <div class="event-list" id="eventList">
        <!-- All available event cards will be displayed here -->
      </div>
    </section>

    <section class="my-events">
      <h1>My Events</h1>
      <div class="event-list" id="myEventList">
        <!-- User's registered events will be displayed here -->
      </div>
    </section>
  </main>

  <footer>
    &copy; 2023 Your Event Website
  </footer>

  <script>
    async function fetchUserProfile() {
      try {
        const token = sessionStorage.getItem('accessToken');
        const userId = sessionStorage.getItem('userId');
        console.log('Token for this user:', token);

        if (!token) {
          console.error('JWT token not found in session storage.');
          return {};
        }

        const response = await fetch(`http://localhost:5000/api/v1/user/${userId}`, {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        });

        const userData = await response.json();

        const profileImage = document.getElementById("profileImage");
        const profileName = document.getElementById("profileName");
        const profileEmail = document.getElementById("profileEmail");
        const profileBio = document.getElementById("profileBio");

        profileImage.src = userData.profileImage;
        profileName.textContent = userData.userName;
        profileEmail.textContent = userData.email;
        profileBio.textContent = userData.bio;

      } catch (error) {
        console.error('Error fetching user profile:', error);
      }
    }

    window.addEventListener("load", fetchUserProfile);

    async function fetchAllEvents() {
      try {
        const token = sessionStorage.getItem('accessToken');
        console.log('Token for this user:', token);

        if (!token) {
          console.error('JWT token not found in session storage.');
          return [];
        }

        const response = await fetch(`http://localhost:5000/api/v1/events`, {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        });

        const data = await response.json();
        console.log("Data: ", data);
        const events = data.events;
        console.log("Events: ", events);
        return events;
      } catch (error) {
        console.error('Error fetching events:', error);
        return [];
      }
    }

    function renderEventCards(events) {
      const eventList = document.getElementById("eventList");

      eventList.innerHTML = "";

      if (events.length === 0) {
        const noEventsMessage = document.createElement("p");
        noEventsMessage.textContent = "There are no events available at the moment.";
        eventList.appendChild(noEventsMessage);
        return;
      }

      events.forEach(event => {
        const eventCard = document.createElement("div");
        eventCard.classList.add("event-card");

        const eventDate = new Date(event.event_date);
        const formattedDate = eventDate.toLocaleDateString(undefined, {
          year: "numeric",
          month: "long",
          day: "numeric",
        });
        const formattedTime = eventDate.toLocaleTimeString(undefined, {
          hour: "2-digit",
          minute: "2-digit",
        });

        eventCard.innerHTML = `
        <h2>${event.event_name}</h2>
        <p><strong>Date:</strong> ${formattedDate}</p>
        <p><strong>Time:</strong> ${formattedTime}</p>
        <p><strong>Location:</strong> ${event.location}</p>
        <p><strong>Description:</strong></p>
        <p>${event.description}</p>
        <button class="register-button">Register</button>
          `;

        eventList.appendChild(eventCard);
      });
    }

    window.addEventListener("load", async () => {
      const availableEvents = await fetchAllEvents();
      renderEventCards(availableEvents);
    });

    async function fetchMyEvents() {
      try {
        const token = sessionStorage.getItem('accessToken');
        console.log('Token for this user:', token);

        if (!token) {
          console.error('JWT token not found in session storage.');
          return [];
        }

        const response = await fetch(`http://localhost:5000/api/v1/my-events`, {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        });

        const data = await response.json();
        return data;
      } catch (error) {
        console.error('Error fetching user events:', error);
        return [];
      }
    }

    function renderMyEventCards(events) {
      const myEventList = document.getElementById("myEventList");

      myEventList.innerHTML = "";

      if (events.length === 0) {
        const noEventsMessage = document.createElement("p");
        noEventsMessage.textContent = "You haven't registered for any events yet.";
        myEventList.appendChild(noEventsMessage);
        return;
      }

      events.forEach(event => {
        const eventCard = document.createElement("div");
        eventCard.classList.add("event-card");

        eventCard.innerHTML = `
          <h2>${event.title}</h2>
          <p>Date: ${event.date}</p>
          <p>Location: ${event.location}</p>
          <p>Description:</p>
          <p>${event.description}</p>
          `;

        myEventList.appendChild(eventCard);
      });
    }

    window.addEventListener("load", async () => {
      const availableEvents = await fetchAllEvents();
      const myEvents = await fetchMyEvents();

      renderEventCards(availableEvents);
      renderMyEventCards(myEvents);
    });

    const applyFiltersButton = document.getElementById("apply-filters");
    applyFiltersButton.addEventListener("click", async () => {
      const category = document.getElementById("event-category").value;
      const location = document.getElementById("event-location").value;

      const filteredEvents = await fetchFilteredEvents(category, location);

      renderEventCards(filteredEvents);
    });
  </script>
</body>
</html>
